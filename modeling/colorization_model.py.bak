import os
import logging
import numpy as np
from PIL import Image
import torch
import torch.nn as nn
from .models.eccv16 import eccv16
from .models.util import *

# 로깅 설정
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class ModelLoadError(Exception):
    """모델 로드 중 발생하는 예외를 처리하기 위한 커스텀 예외 클래스"""
    pass

class ColorizationModel:
    def __init__(self):
        self.device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')
        logger.info(f"컬러화 모델 초기화 중... 사용 중인 디바이스: {self.device}")
        
        self.eccv16_model = None
        
        try:
            # ECCV16 모델 로드
            logger.info("ECCV16 모델 로드 중...")
            self.eccv16_model = eccv16(pretrained=True).to(self.device)
            self.eccv16_model.eval()
            logger.info("ECCV16 모델 로드 완료")
            
            if not self.eccv16_model:
                error_msg = "ECCV16 모델 로드에 실패했습니다."
                logger.error(error_msg)
                raise ModelLoadError(error_msg)
            
        except Exception as e:
            error_msg = f"모델 초기화 중 오류 발생: {str(e)}"
            logger.error(error_msg)
            raise ModelLoadError(error_msg)

class ColorNetwork(nn.Module):
            def __init__(self, norm_layer=nn.BatchNorm2d):
                super().__init__()

                # Conv1
                model1 = [nn.Conv2d(1, 64, kernel_size=3, stride=1, padding=1, bias=True)]
                model1 += [nn.ReLU(True)]
                model1 += [nn.Conv2d(64, 64, kernel_size=3, stride=2, padding=1, bias=True)]
                model1 += [nn.ReLU(True)]
                model1 += [norm_layer(64)]

                # Conv2
                model2 = [nn.Conv2d(64, 128, kernel_size=3, stride=1, padding=1, bias=True)]
                model2 += [nn.ReLU(True)]
                model2 += [nn.Conv2d(128, 128, kernel_size=3, stride=2, padding=1, bias=True)]
                model2 += [nn.ReLU(True)]
                model2 += [norm_layer(128)]

                # Conv3
                model3 = [nn.Conv2d(128, 256, kernel_size=3, stride=1, padding=1, bias=True)]
                model3 += [nn.ReLU(True)]
                model3 += [nn.Conv2d(256, 256, kernel_size=3, stride=1, padding=1, bias=True)]
                model3 += [nn.ReLU(True)]
                model3 += [nn.Conv2d(256, 256, kernel_size=3, stride=2, padding=1, bias=True)]
                model3 += [nn.ReLU(True)]
                model3 += [norm_layer(256)]

                # Conv4
                model4 = [nn.Conv2d(256, 512, kernel_size=3, stride=1, padding=1, bias=True)]
                model4 += [nn.ReLU(True)]
                model4 += [nn.Conv2d(512, 512, kernel_size=3, stride=1, padding=1, bias=True)]
                model4 += [nn.ReLU(True)]
                model4 += [nn.Conv2d(512, 512, kernel_size=3, stride=1, padding=1, bias=True)]
                model4 += [nn.ReLU(True)]
                model4 += [norm_layer(512)]

                # Conv5
                model5 = [nn.Conv2d(512, 512, kernel_size=3, dilation=2, stride=1, padding=2, bias=True)]
                model5 += [nn.ReLU(True)]
                model5 += [nn.Conv2d(512, 512, kernel_size=3, dilation=2, stride=1, padding=2, bias=True)]
                model5 += [nn.ReLU(True)]
                model5 += [nn.Conv2d(512, 512, kernel_size=3, dilation=2, stride=1, padding=2, bias=True)]
                model5 += [nn.ReLU(True)]
                model5 += [norm_layer(512)]

                # Conv6
                model6 = [nn.Conv2d(512, 512, kernel_size=3, dilation=2, stride=1, padding=2, bias=True)]
                model6 += [nn.ReLU(True)]
                model6 += [nn.Conv2d(512, 512, kernel_size=3, dilation=2, stride=1, padding=2, bias=True)]
                model6 += [nn.ReLU(True)]
                model6 += [nn.Conv2d(512, 512, kernel_size=3, dilation=2, stride=1, padding=2, bias=True)]
                model6 += [nn.ReLU(True)]
                model6 += [norm_layer(512)]

                # Conv7
                model7 = [nn.Conv2d(512, 512, kernel_size=3, stride=1, padding=1, bias=True)]
                model7 += [nn.ReLU(True)]
                model7 += [nn.Conv2d(512, 512, kernel_size=3, stride=1, padding=1, bias=True)]
                model7 += [nn.ReLU(True)]
                model7 += [nn.Conv2d(512, 512, kernel_size=3, stride=1, padding=1, bias=True)]
                model7 += [nn.ReLU(True)]
                model7 += [norm_layer(512)]

                # Conv8
                model8 = [nn.ConvTranspose2d(512, 256, kernel_size=4, stride=2, padding=1, bias=True)]
                model8 += [nn.ReLU(True)]
                model8 += [nn.Conv2d(256, 256, kernel_size=3, stride=1, padding=1, bias=True)]
                model8 += [nn.ReLU(True)]
                model8 += [nn.Conv2d(256, 256, kernel_size=3, stride=1, padding=1, bias=True)]
                model8 += [nn.ReLU(True)]
                model8 += [nn.Conv2d(256, 313, kernel_size=1, stride=1, padding=0, bias=True)]

                self.model1 = nn.Sequential(*model1)
                self.model2 = nn.Sequential(*model2)
                self.model3 = nn.Sequential(*model3)
                self.model4 = nn.Sequential(*model4)
                self.model5 = nn.Sequential(*model5)
                self.model6 = nn.Sequential(*model6)
                self.model7 = nn.Sequential(*model7)
                self.model8 = nn.Sequential(*model8)

                self.softmax = nn.Softmax(dim=1)
                self.model_out = nn.Conv2d(313, 2, kernel_size=1, padding=0, dilation=1, stride=1, bias=False)
                self.upsample4 = nn.Upsample(scale_factor=4, mode='bilinear')

            def normalize_l(self, x):
                # normalize L channel to [-1, 1]
                return (x - 50.0) / 100.0

            def unnormalize_ab(self, x):
                # unnormalize ab channels from [-1, 1] to [-110, 110]
                return x * 110.0

            def forward(self, input_l):
                conv1_2 = self.model1(self.normalize_l(input_l))
                conv2_2 = self.model2(conv1_2)
                conv3_3 = self.model3(conv2_2)
                conv4_3 = self.model4(conv3_3)
                conv5_3 = self.model5(conv4_3)
                conv6_3 = self.model6(conv5_3)
                conv7_3 = self.model7(conv6_3)
                conv8_3 = self.model8(conv7_3)
                out_reg = self.model_out(self.softmax(conv8_3))

                return self.unnormalize_ab(self.upsample4(out_reg))

        self.normalize_l = self.eccv16_model.normalize_l
        self.unnormalize_ab = self.eccv16_model.unnormalize_ab
    
    def colorize_with_eccv16(self, image_path):
        if not self.eccv16_model:
            raise ModelLoadError("ECCV16 모델이 로드되지 않았습니다")
        return self._process_image(image_path, self.eccv16_model)
    
    def _process_image(self, image_path, model):
        try:
            if not os.path.exists(image_path):
                raise FileNotFoundError(f"이미지 파일을 찾을 수 없습니다: {image_path}")
            
            # 이미지 로드 및 전처리
            logger.info(f"이미지 처리 중: {image_path}")
            img = load_img(image_path)
            (tens_l_orig, tens_l_rs) = preprocess_img(img, HW=(256,256))
            
            # 이미지 처리
            tens_l_rs = tens_l_rs.to(self.device)
            with torch.no_grad():
                out_ab = model(tens_l_rs)
            
            # 후처리 및 반환
            img_rgb = postprocess_tens(tens_l_orig, out_ab.cpu())
            out_img = Image.fromarray((img_rgb * 255).astype(np.uint8))
            logger.info("이미지 컬러화가 성공적으로 완료되었습니다.")
            return out_img
            
        except Exception as e:
            error_msg = f"이미지 처리 중 오류 발생: {str(e)}"
            logger.error(error_msg)
            raise